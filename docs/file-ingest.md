# File Ingest Recipe

The File Ingest Recipe provides robust asset creation capabilities for
the iconik media platform. It handles all steps of asset creation with
intelligent retry/resume operations, mimicking the behavior of the ISG
(iconik Storage Gateway).

## Overview

This recipe creates assets in iconik with all the necessary supporting
objects (formats, file sets, files) and optionally triggers transcoding
operations. It includes intelligent handling of duplicate detection,
offline files, and integration with the collection directory mapping
feature.

## Features

- Complete asset creation workflow
- Checksum-based duplicate detection
- Support for offline files (files not currently accessible)
- Automatic sidecar metadata handling
- Pattern-based inclusion/exclusion via storage settings
- Transcoding trigger and status checking
- Integration with collection directory mapping
- Command-line interface for easy automation

## Usage

### Python API

```python
from pythonikext import ExtendedPythonikClient
from pythonikext.recipes.file_ingest import FileIngestRecipe

# Create the client
client = ExtendedPythonikClient(
    app_id="your_app_id",
    auth_token="your_auth_token",
    timeout=60
)

# Create the recipe instance
recipe = FileIngestRecipe(
    client=client,
    storage_id="your_storage_id",
    default_view_id="optional_metadata_view_id",  # Optional
    mount_mapping="/local/path:/remote/path"      # Optional
)

# Ingest a file
result = recipe.create_asset(
    file_path="/path/to/file.mp4",
    external_id="custom_external_id",                # Optional
    metadata={"title": "My Video", "description": "Great video"}, # Optional
    collection_ids=["collection1_id", "collection2_id"], # Optional
    md5sum="pre_calculated_md5_checksum",           # Optional
    allow_offline=False                             # Optional
)

# Work with the result
print(f"Created asset with ID: {result['asset_id']}")
print(f"Format ID: {result['format_id']}")
print(f"File ID: {result['file_id']}")
```

### Command Line Interface

The recipe also provides a command-line interface:

```bash
python -m pythonikext.recipes.file_ingest \
    --app-id your_app_id \
    --auth-token your_auth_token \
    --storage-id your_storage_id \
    --external-id custom_external_id \
    --collection-id collection1_id \
    --collection-id collection2_id \
    --view-id metadata_view_id \
    --metadata '{"title": "My Video", "description": "Great video"}' \
    --allow-offline-files \
    --debug \
    /path/to/file.mp4
```

#### Command Line Arguments

- `file_path`: (Required) Path to the file to be created as an asset
- `--app-id`: Iconik App ID (or set ICONIK_APP_ID environment variable)
- `--auth-token`: Iconik Auth Token (or set ICONIK_AUTH_TOKEN
  environment variable)
- `--storage-id`: Storage ID (or set ICONIK_STORAGE_ID environment
  variable)
- `--mount-mapping`: Mount mapping in format "local_path:remote_path"
- `--allow-offline-files`: Create asset for offline files, but skip
  operations requiring the file be online
- `--external-id`: Custom external ID for the asset (defaults to
  autogenerated)
- `--md5sum`: Use a provided checksum instead of calculating one
- `--view-id`: Metadata view ID (defaults to storage settings)
- `--collection-id`: Collection ID to add asset to (can be specified
  multiple times)
- `--metadata`: JSON containing metadata to apply to the asset
- `--debug`: Enable debug logging
- `--timeout`: Maximum wait time (in seconds) for a request to complete
  (default: 60)

#### Metadata Argument Format

The `--metadata` argument accepts:

- Raw JSON string: `--metadata '{"title": "My Video"}'`
- File path: `--metadata @metadata.json`
- Stdin indicator: `--metadata @-` (read from stdin)

## Storage Configuration

The recipe respects several storage settings, including:

- `scan_include`: Patterns that files must match to be processed
- `scan_ignore`: Patterns that files must not match to be processed
- `transcode_include`: Patterns that files must match for transcoding
- `transcode_ignore`: Patterns that files must not match for transcoding
- `sidecar_metadata_required`: Whether sidecar metadata is required
- `title_includes_extension`: Whether asset titles include file
  extensions
- `aggregate_identical_files`: Whether to aggregate files with identical
  checksums
- `aggregate_only_on_same_storage`: Whether to only aggregate on the
  same storage
- `acl_template_id`: ACL template to apply to new assets
- `access_group_id`: Access group to apply to new assets
- `enable_collection_directory_mapping`: Whether to create collection
  hierarchy
- `local_proxy_creation`: Whether to use local proxy creation (not fully
  implemented)

## Implementation Details

The recipe handles multiple steps for asset creation:

1. File validation (exists, matches patterns, has required metadata)
2. Existing asset detection (by external ID or checksum)
3. Asset creation if needed
4. Format creation/verification
5. File set creation/verification
6. File creation/verification
7. Metadata application
8. Collection membership
9. Transcoding triggering (mediainfo, proxies, keyframes)
10. History record creation

Each step includes appropriate error handling and status checking to
ensure robust operation.
